name: ZeroTier SSH Access

on:
  workflow_dispatch:

jobs:
  zerotier-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install ZeroTier
        uses: zerotier/github-action@v1
        with:
          network_id: ${{ secrets.ZEROTIER_NETWORK_ID }}
          auth_token: ${{ secrets.ZEROTIER_CENTRAL_TOKEN }}

      - name: Create SSH User
        run: |
          sudo useradd -m sshuser
          echo "sshuser:Coderz4571!" | sudo chpasswd
          sudo usermod -aG sudo sshuser
          echo "SSH_PASSWORD=Coderz4571!" >> $GITHUB_ENV

      - name: Get ZeroTier IP
        run: |
          ZT_IP=$(zerotier-cli listpeers | grep -oP '100\.\d+\.\d+\.\d+')
          echo "ZEROTIER_IP=$ZT_IP" >> $GITHUB_ENV

      - name: Show SSH Access Info
        run: |
          echo ""
          echo "=== SSH ACCESS ==="
          echo "Address: $ZEROTIER_IP"
          echo "Username: sshuser"
          echo "Password: $SSH_PASSWORD"
          echo "=================="
          while true; do
            echo "[ $(date) ] SSH Active - Use Ctrl+C to terminate"
            sleep 300
          done
