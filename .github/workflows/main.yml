name: Twingate Connector Setup

on:
  workflow_dispatch:

jobs:
  twingate-connector:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Twingate CLI via APT
        run: |
          echo "🔧 Twingate CLI kuruluyor..."
          echo "deb [trusted=yes] https://packages.twingate.com/apt/ /" | sudo tee /etc/apt/sources.list.d/twingate.list
          sudo apt update -yq
          sudo apt install -yq twingate
          echo "✅ Twingate CLI kuruldu"

      - name: Authenticate Connector with Tokens
        run: |
          echo "🔐 Connector bağlanıyor..."
          echo "${{ secrets.TWINGATE_ACCESS_TOKEN }}" > access.token
          echo "${{ secrets.TWINGATE_REFRESH_TOKEN }}" > refresh.token
          sudo twingate setup --access-token "$(cat access.token)" --refresh-token "$(cat refresh.token)"
          sudo twingate start
          sleep 15
          echo "✅ Connector ağa bağlandı"

      - name: Show Connector IP
        run: |
          IP=$(hostname -I | awk '{print $1}')
          echo "Connector IP: $IP"
          echo "TWINGATE_IP=$IP" >> $GITHUB_ENV

      - name: Keep Connector Alive
        run: |
          echo ""
          echo "=== TWINGATE CONNECTOR ACTIVE ==="
          echo "IP: $TWINGATE_IP"
          while true; do
            echo "[ $(date) ] Connector çalışıyor..."
            sleep 300
          done
