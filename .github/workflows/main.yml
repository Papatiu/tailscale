name: Twingate Headless Connector with SSH

on:
  workflow_dispatch:

jobs:
  twingate-connector:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Twingate Headless Client
        run: |
          echo "ðŸ”§ Twingate Client kuruluyor..."
          echo "deb [trusted=yes] https://packages.twingate.com/apt/ /" | sudo tee /etc/apt/sources.list.d/twingate.list
          sudo apt update -yq
          sudo apt install -yq twingate

      - name: Setup and Start Twingate
        env:
          TWINGATE_SERVICE_KEY: ${{ secrets.TWINGATE_SERVICE_KEY }}
        run: |
          echo "$TWINGATE_SERVICE_KEY" | sudo twingate setup --headless=-
          sudo twingate start
          echo "âœ… Twingate baÄŸlantÄ±sÄ± kuruldu"
          sleep 10

      - name: Create SSH User
        run: |
          sudo useradd -m sshuser
          echo "sshuser:Coderz4571!" | sudo chpasswd
          sudo usermod -aG sudo sshuser
          echo "SSH_PASSWORD=Coderz4571!" >> $GITHUB_ENV
          echo "âœ… SSH kullanÄ±cÄ± oluÅŸturuldu"

      - name: Show Connector IP
        run: |
          IP=$(hostname -I | awk '{print $1}')
          echo "Connector IP: $IP"
          echo "TWINGATE_IP=$IP" >> $GITHUB_ENV

      - name: Keep Connector Alive
        run: |
          echo ""
          echo "=== TWINGATE CONNECTOR ACTIVE ==="
          echo "IP: $TWINGATE_IP"
          echo "Username: sshuser"
          echo "Password: $SSH_PASSWORD"
          while true; do
            echo "[ $(date) ] Connector Ã§alÄ±ÅŸÄ±yor..."
            sleep 300
          done
