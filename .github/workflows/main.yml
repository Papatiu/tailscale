name: Twingate Connector Setup

on:
  workflow_dispatch:

jobs:
  twingate-connector:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Twingate Connector CLI
        run: |
          echo "🔧 Twingate CLI kuruluyor..."
          curl -fsSL https://binaries.twingate.com/connector/setup.sh -o setup.sh
          chmod +x setup.sh
          sudo ./setup.sh
          echo "✅ Twingate CLI kuruldu"

      - name: Authenticate Connector with Tokens
        run: |
          echo "🔐 Connector bağlanıyor..."
          sudo /opt/twingate/setup \
            --access-token "${{ secrets.TWINGATE_ACCESS_TOKEN }}" \
            --refresh-token "${{ secrets.TWINGATE_REFRESH_TOKEN }}"
          sleep 15
          echo "✅ Connector ağa bağlandı"

      - name: Show Connector IP
        run: |
          IP=$(hostname -I | awk '{print $1}')
          echo "Connector IP: $IP"
          echo "TWINGATE_IP=$IP" >> $GITHUB_ENV

      - name: Keep Connector Alive
        run: |
          echo ""
          echo "=== TWINGATE CONNECTOR ACTIVE ==="
          echo "IP: $TWINGATE_IP"
          while true; do
            echo "[ $(date) ] Connector çalışıyor..."
            sleep 300
          done
